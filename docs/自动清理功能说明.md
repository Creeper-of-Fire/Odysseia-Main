# 自动清理功能说明

## 功能概述

自动清理功能是thread_manage模块的新增功能，可以自动检测满员（1000人）的子区并执行清理任务，每次清理约50名不活跃用户。

## 功能特性

### 1. 自动检测与执行
- 通过监听消息事件实现高效检测
- 当用户在子区发送消息时，自动检查子区人数
- 如果达到1000人满员状态，自动启动清理任务
- 每次清理约50名不活跃成员（阈值设为950）

### 2. 防重复清理机制
- 如果已有手动清理任务进行中，跳过自动检测
- 如果已有自动清理任务进行中，手动清理会提示等待
- 确保同一子区不会同时执行多个清理任务

### 3. 实时进度显示
- 所有正在进行的自动清理任务在日志频道集中显示
- 使用单一embed消息展示所有任务状态
- 每30秒自动更新进度信息
- 显示统计阶段和清理阶段的详细进度

### 4. 子区级别控制
- 子区所有者可以通过指令开启/关闭自动清理
- 被禁用的子区列表持久化保存
- 支持查看当前子区的自动清理状态

## 使用指令

### `/自助管理 自动清理 [操作]`

**参数选项：**
- `🟢 开启自动清理` - 为当前子区开启自动清理功能
- `🔴 关闭自动清理` - 为当前子区关闭自动清理功能  
- `📊 查看状态` - 查看当前子区的自动清理配置和状态

**权限要求：**
- 仅子区所有者或管理员可以使用
- 必须在子区内使用此指令

## 工作流程

1. **消息监听**：当用户在子区发送消息时触发检测
2. **条件检查**：
   - 检查子区是否被禁用自动清理
   - 检查是否已有正在进行的清理任务
   - 检查子区成员数是否达到1000人
3. **任务执行**：
   - 创建自动清理任务对象
   - 启动日志更新循环（如未启动）
   - 异步执行清理过程
4. **进度更新**：
   - 统计阶段：显示已处理消息数量
   - 清理阶段：显示清理进度百分比
   - 完成后显示移除成员数量
5. **任务清理**：任务完成5分钟后自动从活跃任务列表中移除

## 日志显示

在配置的日志频道中，自动清理状态以embed消息形式显示：

```
🤖 自动清理任务状态
当前有 X 个自动清理任务正在进行

📝 [子区名称]
📊 统计阶段: 已处理 XXX 条消息
⏱️ 运行时间: X分X秒

📝 [子区名称]  
🧹 清理阶段: XX/XX (XX%)
⏱️ 运行时间: X分X秒
```

## 数据存储

- **禁用列表**：`data/auto_clear_disabled.json`
- **消息统计缓存**：`data/thread_cache/{thread_id}.json`（复用现有清理功能）

## 技术实现

### 核心文件
- `src/thread_manage/auto_clear.py` - 自动清理管理器
- `src/thread_manage/cog.py` - 主要功能集成
- `src/thread_manage/thread_clear.py` - 清理逻辑（复用）

### 关键类
- `AutoClearManager` - 自动清理管理器
- `AutoClearTask` - 单个清理任务状态跟踪

## 注意事项

1. **性能优化**：使用消息事件监听而非定时任务，减少系统负载
2. **错误处理**：自动清理失败不会影响正常的手动清理功能
3. **权限控制**：保持与手动清理相同的权限验证机制
4. **日志配置**：需要在config.json中正确配置logging部分才能显示进度
5. **数据一致性**：禁用列表和任务状态都有完善的持久化机制

## 配置要求

确保config.json中包含日志配置：

```json
{
  "logging": {
    "enabled": true,
    "guild_id": "你的服务器ID",
    "channel_id": "日志频道ID",
    "level": "INFO"
  }
}
```

如果未配置日志频道，自动清理功能仍可正常工作，但不会显示进度信息。 