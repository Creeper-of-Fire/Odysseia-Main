# 🚀 Odysseia Discord Bot

一个功能强大的 Discord 机器人，专为类脑服务器管理而设计。现支持同时进行多服务器隔离管理。

## 📋 项目简介

Odysseia Discord Bot 是基于原有机器人项目的增强版本，针对原版本的局限性进行了改进，增加了多项功能，适合需要管理多个Discord服务器和处理用户反馈的社区。但同时也具有更高的硬件配置需求。

## 🔄 相比原版本的改进

### 🆕 核心新增功能

#### 1. 匿名反馈系统
**设计理念**：避免用户在预设/卡区等帖子进行反馈是由于chat记录和log记录包含敏感信息而导致不愿意积极反馈的情况出现。
**改进方案**：
-  **论坛专用**：只在论坛频道的帖子下工作的匿名交流功能
-  **完全自动化**：无需任何配置，在论坛频道的帖子下即可使用
-  **帖主权限**：帖主可追踪和管理针对自己帖子的匿名反馈
-  **反垃圾系统**：👎反应监控、频率限制、三警告封禁机制
-  **管理员工具**：管理员可处理恶意反馈，但无法追踪
-  **SQLite数据库**：架构了一个SQLite数据库用于服务匿名反馈系统，保证该系统各种意义上的安全性


### 🔧 性能与安全优化

#### 理论上的性能提升 
**改进**：
-  **配置缓存系统**：智能缓存，减少文件读取开销
-  **线程安全机制**：确保并发访问的数据一致性
-  **批量日志处理**：避免API频率限制


### 🛠️ 用户体验改进

#### 部署体验
**方案**：
-  **一键快速部署**：`python 快速部署.py` 交互式配置
-  **配置验证器**：自动检查配置文件正确性
-  **服务器信息获取工具**：自动获取Discord服务器信息
-  **详细文档**：完整的部署和使用指南

### 修复一些issue
-  **/管理 频道管理 指令**：现在slowmode支持关闭慢速模式
-  **修复了原赛事系统的一个隐藏issue**：赛事身份组发放功能初始化时的 _load_views 方法中，当views.json文件不存在时，会将 self.views 初始化为字典 {}，但后续的 _add_view 方法尝试使用 self.views.append()，这需要 self.views 是一个列表。如果 data/event/views.json 已经存在且格式正确，则不会触发bug，但如果在空配置环境下初次开始此功能，会导致无法正常运行。
-  **现在管理员的处罚撤销指令可以撤销永baan处罚**：原代码中执行该逻辑时，会因为永ban用户不存在于服务器中导致逻辑失败。尽管discord服务器可以手动管理永ban列表，但还是选择修复了此issue。
-  **bot的/管理模块指令修复**：现在支持使用bot指令热处理模块功能的开关

##  完整功能列表

所有指令均为斜杠命令 (/)。

### 🔧 子区自助管理 (`/自助管理`)
- `/自助管理 清理子区 [阈值天数]` - 清理子区内超过指定天数未发言的非置顶成员。
- `/自助管理 删除消息 [消息链接]` - 删除子区内指定的单条消息。
- `/自助管理 删帖` - 删除当前所在的整个子区。
- `/自助管理 锁定子区 [原因]` - 锁定当前帖子，禁止普通用户发言。
- `/自助管理 解锁子区` - 解锁当前帖子，允许普通用户发言。
- `/自助管理 慢速模式 [秒数]` - 为当前子区设置慢速模式 (0-21600秒)。
- `/自助管理 标注 [操作(标注/取消标注)] [消息链接]` - 标注或取消标注帖子内的消息。

### 📢 匿名反馈 (`/匿名反馈`)
**重要说明**: 匿名反馈系统采用三次警告制。用户在特定帖主下累计3次警告（通过👎举报、帖主封禁、管理员删除触发）将被该帖主封禁，无法再在该帖主的所有帖子下发送匿名反馈。
- `/匿名反馈 消息 [内容]` - 在当前论坛帖子中发送匿名文字消息。
- `/匿名反馈 图片 [说明(可选)]` - 在当前论坛帖子中发送匿名图片。机器人会私聊提示上传图片。
- `/匿名反馈 文件 [说明(可选)]` - 在当前论坛帖子中发送匿名文件。机器人会私聊提示上传文件。

### 🗣️ 帖主反馈管理 (`/帖主`) (仅帖主可用)
- `/帖主 溯源反馈 [反馈编号]` - 查看自己帖子中指定匿名反馈的发送者身份。
- `/帖主 封禁反馈用户 [反馈编号] [原因(可选)]` - 封禁向自己帖子发送指定反馈的用户（计为一次警告）。
- `/帖主 减少警告 [用户] [次数(可选)]` - 减少指定用户在自己名下的警告次数。

### 🛡️ 匿名反馈管理 (`/匿名反馈管理`) (仅管理员可用)
- `/匿名反馈管理 删除反馈 [反馈编号] [原因(可选)]` - 删除指定匿名反馈并警告发送者（计为一次警告）。
- `/匿名反馈管理 查询反馈 [反馈编号]` - 查询指定匿名反馈的详细信息（包括发送者）。
- `/匿名反馈管理 用户统计 [用户]` - 查看指定用户的匿名反馈统计数据。
- `/匿名反馈管理 封禁 [用户] [原因(可选)]` - 全局封禁用户使用匿名反馈功能。
- `/匿名反馈管理 解封 [用户]` - 全局解封用户使用匿名反馈功能。

### 👮 管理员 (`/管理`)
- `/管理 批量删除消息 [起始消息链接] [结束消息链接(可选)]` ✅ - 删除指定范围内的消息。若无结束消息链接，则删除起始消息后的50条。智能处理14天限制。
- `/管理 一键删帖 [用户] [频道(可选)]` ✅ - 删除指定用户在特定频道或所有频道发布的帖子（支持活跃与归档线程）。
- `/管理 身份组 添加 [用户] [身份组]` - 给用户添加身份组。
- `/管理 身份组 移除 [用户] [身份组]` - 从用户移除身份组。
- `/管理 身份组 批量转移 [原身份组] [新身份组] [移除原身份组(是/否)]` - 批量转移身份组成员。
- `/管理 禁言 [用户] [时长] [原因(可选)]` - 禁言用户 (例如：1d, 2h, 30m)。
- `/管理 永封 [用户] [原因(可选)] [截图(可选)]` - 永久封禁用户。
- `/管理 撤销处罚 [处罚ID] [原因(可选)]` - 撤销指定的处罚记录。
- `/管理 频道管理 编辑 [频道] [新名称(可选)] [慢速模式(可选)] [nsfw(可选)] [帖子自动归档时长(可选)]` - 编辑频道属性。
- `/管理 子区管理 锁定 [帖子]` - 锁定指定帖子。
- `/管理 子区管理 解锁 [帖子]` - 解锁指定帖子。
- `/管理 子区管理 归档 [帖子]` - 归档指定帖子。
- `/管理 子区管理 取消归档 [帖子]` - 取消归档指定帖子。
- `/管理 子区管理 置顶 [帖子内某条消息的链接或ID]` - 置顶帖子内的某条消息。
- `/管理 子区管理 取消置顶 [帖子内某条置顶消息的链接或ID]` - 取消置顶帖子内的某条消息。
- `/管理 子区管理 删除 [帖子]` - 删除指定帖子。
- `/管理 答题处罚 [用户]` - 对用户进行答题处罚（通常是移除特定身份组并赋予"答题"身份组）。

### ✅ 验证系统 (通常无直接命令，通过按钮交互)
- 验证系统通过用户点击按钮触发，题目和流程在后台配置。
- 管理员可通过 `/管理 身份组` 手动操作验证相关身份组。

### 🎮 赛事管理 (`/赛事`)
- `/赛事 自助身份组发放 [操作(获取/放弃)] [身份组]` - 用户自助获取或放弃指定的赛事身份组。
- `/赛事 检查发帖 [身份组] [频道]` - 检查拥有指定身份组的成员是否在目标频道发帖。

### 🤖 机器人管理 (`/机器人管理`)
- `/机器人管理 模块列表` - 列出所有功能模块及其启用状态。
- `/机器人管理 启用模块 [模块名]` - 启用指定的功能模块。
- `/机器人管理 禁用模块 [模块名]` - 禁用指定的功能模块。
- `/机器人管理 重载模块 [模块名]` - 重新加载指定的功能模块代码。
- `/机器人管理 ping` - 测试机器人与Discord的延迟。
- `/机器人管理 更新指令` - 手动在当前服务器更新斜杠指令。
- `/机器人管理 状态 [类型(playing/watching/listening/competing)] [内容]` - 修改机器人当前状态。

### 🔄 服务器同步
- 功能主要通过 `config/server_sync/config.json` 进行配置。
### 同步指令Add commentMore actions
- `/同步 身份组同步` - 同步可同步的身份组到配置中的全部子服务器

### 同步管理指令
- `/同步管理 添加服务器` - 将当前服务器添加到同步列表
- `/同步管理 删除服务器` - 从同步列表中删除当前服务器
- `/同步管理 身份组 <名字> <@身份组>` - 将身份组添加到同步列表
- `/同步管理 处罚同步 开/关` - 此服务器是否参与处罚同步
- `/同步管理 处罚公示频道 <选择频道>` - 设置此服务器的处罚公示频道
- `/同步管理 处罚确认频道 <选择频道>` - 设置此服务器的处罚同步确认频道

## 🚀 快速开始

### 一键部署（推荐新手）
```bash
# 1. 克隆项目
git clone <repository-url>
cd Odysseia-Main

# 2. 安装依赖
pip install -r requirements.txt

# 3. 快速配置（交互式配置向导）
python 快速部署.py

# 4. 验证配置
python config_validator.py

# 5. 启动机器人
python main.py
```

### 手动配置（推荐）
如果您需要更精细的配置控制，请参考 [部署指南.md](部署指南.md) 获取详细说明。

## 📁 项目结构
```
Odysseia-Main-new/
├── main.py                     # 主程序入口
├── config.json                 # 配置文件 (用户创建)
├── config.example.json         # 配置文件示例
├── requirements.txt            # Python 依赖列表
├── 快速部署.py                 # 快速配置脚本
├── config_validator.py         # 配置验证脚本
├── get_new_server_info.py      # 服务器信息获取脚本
├── check_permissions.py        # 权限检查脚本
├── docs/                       # 文档目录 (部署指南等)
├── src/                        # 源代码目录
│   ├── admin/                  # 管理员功能模块
│   ├── anonymous_feedback/     # 匿名反馈模块
│   ├── bot_manage/             # 机器人管理模块
│   ├── event/                  # 赛事管理模块
│   ├── misc/                   # 杂项功能模块
│   ├── sync/                   # 服务器同步模块
│   ├── thread_manage/          # 子区自助管理模块
│   ├── utils/                  # 工具函数和类
│   └── verify/                 # 验证系统模块
├── data/                       # 数据存储目录 (自动创建)
│   └── anonymous_feedback.db   # 匿名反馈数据库
└── logs/                       # 日志文件目录 (自动创建)
```

## ⚙️ 配置文件说明

### 基础配置结构
```json
{
    "token": "你的机器人Token",
    "status": "watching", 
    "status_text": "子区里的一切",
    "admins": [123456789012345678],  // 全局bot管理员，支持用户ID(推荐)和身份组ID
    
    "cogs": {
        "thread_manage": {"enabled": true, "description": "子区自助管理功能"},
        "admin": {"enabled": true, "description": "管理员功能"},
        "anonymous_feedback": {"enabled": true, "description": "匿名反馈系统"},
        "verify": {"enabled": true, "description": "验证系统"},
        "misc": {"enabled": true, "description": "杂项功能"},
        "event": {"enabled": true, "description": "赛事管理功能"},
        "bot_manage": {"enabled": true, "description": "机器人管理功能"},
        "sync": {"enabled": true, "description": "服务器同步功能"}
    },
    
    "logging": {
        "enabled": true,
        "guild_id": 你的服务器ID,
        "channel_id": 日志频道ID,
        "level": "INFO"
    },
    
    "verified_role_id": 验证身份组ID,
    "buffer_role_id": 缓冲身份组ID,
    "quiz_role_id": 答题身份组ID,
    "warned_role_id": 警告身份组ID,
    "punish_announce_channel_id": 处罚频道ID,
    
    // 必填项
    "event_managers": [赛事管理员用户ID列表],
    "highest_role_available": 最高可管理身份组ID  // 设为0表示无限制，如果设置为"版主"身份组ID，赛事管理员只能创建"版主"及以下级别身份组的自助发放，无法创建"管理员"或"服主"等更高级别身份组的自助发放
}
```

### 重要配置说明
- **权限配置差异**：
  - 全局管理员 (`admins`)：最好请使用**用户ID**
  - 服务器管理员使用**身份组ID**
- **匿名反馈系统**：完全自动化，只需启用模块，无需额外配置
- **验证系统**：题目和流程在代码中硬编码，只需配置身份组ID
- **必填项**：`event_managers`和`highest_role_available`为必填配置项。

详细配置说明请查看 `config.example.json` 文件。



## 🔧 实用工具

### 快速部署脚本
```bash
python 快速部署.py
```
交互式配置向导，适合零代码基础用户，包含：
-  机器人基础信息设置
-  全局管理员配置
-  多服务器配置
-  功能模块选择
-  自动配置验证和保存

### 配置验证器
```bash
python config_validator.py
```
自动检查配置文件的正确性，发现问题并提供修复建议。

### 服务器信息获取器
```bash
python get_new_server_info.py
```
自动获取Discord服务器的ID、频道ID、身份组ID等信息。

### 权限检查器
```bash
python check_permissions.py
```
检查机器人在各个服务器的权限配置是否正确。

### 测试运行器
```bash
python run_tests.py
```
运行完整的测试套件，检查代码质量和功能完整性。

## 🔍 故障排除

### 常见问题及解决方案

#### 1. 机器人无法启动
**可能原因**：
- Token错误或过期
- Python版本不兼容
- 依赖包缺失

**解决方案**：
```bash
# 检查Python版本
python --version

# 重新安装依赖
pip install -r requirements.txt --upgrade

# 验证配置
python config_validator.py
```

#### 2. 斜杠命令不显示
**可能原因**：
- 缺少 `applications.commands` 权限
- 应用命令同步延迟

**解决方案**：
1. 重新邀请机器人并确保勾选 `applications.commands` 权限
2. 等待几分钟让Discord同步命令

#### 3. 匿名反馈失败
**可能原因**：
- 目标频道权限不足
- 不是论坛频道的帖子
- 反馈功能未启用

**解决方案**：
1. 检查机器人在目标频道的权限
2. 确保是在论坛频道的帖子内使用
3. 在配置文件中启用匿名反馈功能

#### 4. 多服务器数据混乱
**可能原因**：
- 配置文件中服务器ID配置错误
- 权限配置错误

**解决方案**：
```bash
# 运行配置验证器
python config_validator.py

# 检查权限配置
python check_permissions.py
```

### 获取技术支持
1. **📖 查看文档**：详细阅读 [部署指南.md](部署指南.md)
2. **🔍 运行诊断**：使用 `python config_validator.py` 自动诊断
3. **📊 检查日志**：查看机器人日志频道的详细错误信息
4. **🚀 重新配置**：使用 `python 快速部署.py` 重新进行配置

##  贡献指南

### 开发环境设置
```bash
# 克隆项目
git clone <repository-url>
cd Odysseia-Main

# 创建虚拟环境
python -m venv venv
source venv/bin/activate  # Linux/Mac
# 或
venv\Scripts\activate  # Windows

# 安装开发依赖
pip install -r requirements.txt
pip install -r requirements-test.txt

# 运行测试
python run_tests.py
```

### 代码贡献流程
1. Fork 项目
2. 创建功能分支
3. 编写代码和测试
4. 提交 Pull Request

## 📄 许可证

本项目使用 MIT 与 Commons Clause 混合许可证。详情请查看 [LICENSE](LICENSE) 文件。

## 🙏 致谢

感谢所有贡献者和社区成员的支持，特别是：
- 原始 Odysseia Bot 项目的开发者
- Discord.py 库的维护者
- 所有提供反馈和建议的用户