# 🚀 Odysseia Discord Bot 部署指南

---

##  前置准备


### 1. 软件环境
- ✅ **Python 3.10+** 已安装
- ✅ **Git** 已安装（可选，用于更新）
- ✅ **文本编辑器** （推荐 VS Code 或 Notepad++）

### 2. Discord准备
- ✅ Discord账号
- ✅ 测试服务器（强烈推荐新建一个用于测试）
- ✅ 管理员权限

---

## 🤖 第一步：创建Discord机器人

### 1.1 访问discord dev平台
1. 前往：https://discord.com/developers/applications
2. 使用Discord账号登录

### 1.2 创建应用程序
1. 点击右上角 `New Application`
2. 输入名称：`您喜欢的bot名称` 
3. 点击 `Create`

### 1.3 创建机器人
1. 左侧菜单点击 `Bot`
2. 点击 `Add Bot` → `Yes, do it!`
3. 设置机器人名称和头像
4. **可选**: 设置机器人描述

### 1.4 配置重要权限 ⚠️
**必须启用以下选项，否则机器人无法正常工作**：
- ✅ `MESSAGE CONTENT INTENT`
- ✅ `SERVER MEMBERS INTENT` 
- ✅ `PRESENCE INTENT`

### 1.5 获取Token
1. 在Token部分点击 `Copy` 
2. **⚠️ 重要**: 妥善保管Token，绝不要在任何地方泄露
3. 建议将Token保存到安全的密码管理器中

---

## 🔗 第二步：邀请机器人到服务器

### 2.1 生成邀请链接
1. 左侧菜单：`OAuth2` → `URL Generator`
2. **Scopes** 选择：
   - ✅ `bot`
   - ✅ `applications.commands`
3. **Bot Permissions** 选择：
   - ✅ `Administrator` （推荐，一键配置所有权限）
   
### 2.2 邀请到服务器
1. 复制生成的URL链接
2. 在浏览器中打开链接
3. 选择目标服务器
4. 确认权限并点击授权

---

## 🔧 第三步：下载并配置机器人

### 3.1 下载项目
**方法一：Git克隆**（推荐）
```bash
git clone <项目地址>
cd Odysseia-Main
```

**方法二：下载ZIP**
1. 下载项目ZIP文件
2. 解压到合适的目录
3. 进入 `Odysseia-Main` 文件夹

### 3.2 安装依赖
```bash
pip install -r requirements.txt
```

如果遇到权限问题，使用：
```bash
pip install -r requirements.txt --user
```

### 3.3 创建配置文件
**推荐方法一：使用快速部署脚本**
```bash
python 快速部署.py
```

**方法二：手动配置**
复制配置示例文件：
```bash
cp config.example.json config.json
```

---

## ⚙️ 第四步：配置机器人

### 4.1 基础配置结构
创建 `config.json` 文件，包含以下基础结构：

```json
{
    "token": "你的机器人Token",
    "status": "watching",
    "status_text": "子区里的一切",
    "admins": [管理员用户ID列表],
    
    "cogs": {
        "thread_manage": {"enabled": true, "description": "子区自助管理功能"},
        "admin": {"enabled": true, "description": "管理员功能"},
        "anonymous_feedback": {"enabled": true, "description": "匿名反馈系统"},
        "verify": {"enabled": true, "description": "验证系统"},
        "misc": {"enabled": true, "description": "杂项功能"},
        "event": {"enabled": true, "description": "赛事管理功能"},
        "bot_manage": {"enabled": true, "description": "机器人管理功能"},
        "sync": {"enabled": true, "description": "服务器同步功能"}
    },
    
    "logging": {
        "enabled": true,
        "guild_id": 你的服务器ID,
        "channel_id": 日志频道ID,
        "level": "INFO"
    },
    
    "verified_role_id": 验证身份组ID,
    "buffer_role_id": 缓冲身份组ID,
    "quiz_role_id": 答题身份组ID,
    "warned_role_id": 警告身份组ID,
    "punish_announce_channel_id": 处罚公示频道ID,
    
    "event_managers": [赛事管理员用户ID列表],
    "highest_role_available": 最高可管理身份组ID
}
```

**重要更新说明：**
- `event_managers` 和 `highest_role_available` 为**必填项**
- `highest_role_available` 设为 `0` 表示无身份组限制
- 匿名反馈系统为自动化功能，无需额外配置

### 4.2 获取必要的ID信息

#### 启用开发者模式
1. Discord设置 → 高级 → 开发者模式（开启）

#### 获取各种ID
- **服务器ID**: 右键服务器名称 → 复制服务器ID
- **用户ID**: 右键自己头像 → 复制用户ID  
- **频道ID**: 右键频道名称 → 复制频道ID
- **角色ID**: 服务器设置 → 角色 → 右键角色 → 复制角色ID

### 4.3 创建必要的身份组和频道

#### 必需身份组
在服务器设置中创建以下身份组：
1. **已验证** - 给通过验证的用户
2. **验证缓冲** - 验证过程中的临时身份组  
3. **答题验证** - 需要重新答题的用户
4. **警告状态** - 被警告的用户

#### 必需频道
建议创建以下频道：
1. **机器人日志** - 记录机器人运行日志
2. **处罚公示** - 公示封禁/警告等处罚
3. **验证频道** - 用户验证入口

---

## 🚀 第五步：启动机器人

### 5.1 首次启动
在项目目录中执行：
```bash
python main.py
```

### 5.2 验证启动状态
成功启动后应显示：
- ✅ 配置文件加载成功
- ✅ 各功能模块加载状态
- ✅ 连接Discord成功
- ✅ 机器人上线通知

### 5.3 常见启动问题
**Token错误**：
```
discord.errors.LoginFailure
```
解决：检查config.json中的token是否正确

**权限错误**：
```
discord.errors.Forbidden
```
解决：确保机器人有足够权限，重新邀请并授予管理员权限

**模块加载失败**：
```
ImportError or ModuleNotFoundError
```
解决：重新安装依赖 `pip install -r requirements.txt`

---

## 🎯 第六步：功能测试

### 6.1 基础命令测试
测试以下命令确保功能正常：

1. **管理功能**
   - `/管理 身份组` - 测试身份组管理
   - `/管理 禁言` - 测试禁言功能
   - `/管理 永封` - 测试封禁功能
   - `/管理 批量删除消息` - 测试批量删除功能
   - `/管理 一键删帖` - 测试一键删帖功能

2. **匿名反馈** 🆕 (自动化系统)
   - `/匿名反馈 消息` - 在论坛帖子中测试匿名消息
   - `/匿名反馈 图片` - 在论坛帖子中测试匿名图片
   - `/匿名反馈 文件` - 在论坛帖子中测试匿名文件
   - `/匿名反馈管理 删除反馈` - 测试管理员删除功能（新增三次警告制）

3. **子区管理** 🔧
   - `/自助管理 清理子区` - 在论坛帖中测试
   - `/自助管理 锁定子区` - 测试子区锁定
   - `/自助管理 删帖` - 测试删除功能

4. **验证系统**
   - 检查验证频道按钮是否出现
   - 测试完整验证流程

5. **赛事管理**
   - `/赛事 自助身份组发放` - 测试身份组自助获取
   - `/赛事 检查发帖` - 测试发帖检查功能

6. **帖主功能** 🆕
   - `/帖主 溯源反馈` - 测试帖主查看匿名反馈者身份
   - `/帖主 封禁反馈用户` - 测试帖主封禁功能（三次警告制）
   - `/帖主 减少警告` - 测试帖主减少用户警告

### 6.2 权限验证
- ✅ 管理员可以使用所有管理命令
- ✅ 普通用户只能使用基础功能
- ✅ 帖主可以管理自己的帖子
- ✅ 非帖主无法使用帖主专属功能

---

## 🆕 匿名反馈系统详解

本机器人的匿名反馈系统是**自动化的论坛专用功能**，专门设计用于论坛类频道的帖子讨论。

### 功能特点
- **论坛专用**: 只能在论坛类频道(Forum Channel)的帖子内使用
- **完全自动化**: 无需任何配置，开箱即用
- **完全匿名**: 通过加密cookie系统确保用户身份不可追踪
- **多媒体支持**: 支持匿名发送文字、图片、文件
- **智能管理**: 内置反垃圾和举报机制
- **三次警告制**: 用户在特定帖主下累计3次警告将被封禁

### 警告机制详解
#### 警告触发条件
1. **👎 负面反应**: 反馈收到10个👎自动删除并警告
2. **帖主封禁**: 帖主主动封禁用户反馈
3. **管理员删除**: 管理员删除恶意反馈

#### 警告计算方式
- 每个用户在**每个帖主**下分别计算警告次数
- 不同帖主的警告互不影响
- 达到3次警告时自动封禁该用户在对应帖主帖子下的反馈权限

### 使用说明
匿名反馈系统**不需要任何配置**，只要在`config.json`中启用了`anonymous_feedback`模块即可使用：

```json
"cogs": {
    "anonymous_feedback": {"enabled": true}
}
```

### 使用流程
1. 用户在论坛帖子内使用匿名反馈命令
2. 系统自动生成加密的匿名身份标识
3. 匿名消息直接发送到当前帖子中
4. 其他用户看到的是完全匿名的消息
5. 支持对匿名消息进行举报和管理

### 可用命令
#### 用户命令
- `/匿名反馈 消息 [内容]` - 发送匿名文字消息
- `/匿名反馈 图片` - 发送匿名图片（会提示上传）
- `/匿名反馈 文件` - 发送匿名文件（会提示上传）

#### 帖主命令
- `/帖主 溯源反馈 [反馈编号]` - 查看匿名反馈者身份
- `/帖主 封禁反馈用户 [反馈编号] [原因]` - 封禁用户反馈权限
- `/帖主 减少警告 [用户] [次数]` - 减少用户警告次数

#### 管理员命令
- `/匿名反馈管理 删除反馈 [反馈编号] [原因]` - 删除匿名反馈
- `/匿名反馈管理 查询反馈 [反馈编号]` - 查询反馈详情
- `/匿名反馈管理 用户统计 [用户]` - 查看用户统计
- `/匿名反馈管理 封禁 [用户] [原因]` - 全局封禁用户

### 管理功能
- 管理员可以删除匿名消息并自动计入三次警告制
- 支持用户举报不当匿名内容（👎达到10个自动删除）
- 内置反垃圾信息机制（24小时内最多20条反馈）
- 自动记录违规行为日志

---

## 🔧 故障排除指南

### 启动问题

#### 1. Python版本不兼容
**症状**: `SyntaxError` 或版本警告
**解决**: 升级到Python 3.10+
```bash
python --version
```

#### 2. 依赖包缺失
**症状**: `ModuleNotFoundError`
**解决**: 重新安装依赖
```bash
pip install -r requirements.txt --upgrade
```

#### 3. 配置文件错误
**症状**: `JSONDecodeError` 或配置加载失败
**解决**: 
1. 检查config.json语法
2. 使用JSON验证器验证格式
3. 确保所有ID为数字类型
4. 检查必填项：event_managers 和 highest_role_available

### 功能问题

#### 1. 匿名反馈系统无法使用
**症状**: 命令无响应或提示错误
**解决**:
1. 确保在论坛频道的帖子内使用
2. 检查anonymous_feedback模块是否启用
3. 验证机器人权限

#### 2. 验证系统无法正常工作
**症状**: 验证按钮不出现或验证失败
**解决**:
1. 检查相关身份组是否存在
2. 确保身份组ID配置正确
3. 验证机器人有身份组管理权限

#### 3. 管理命令权限不足
**症状**: 提示无权限使用管理命令
**解决**:
1. 检查用户ID是否在admins列表中（现在支持用户ID）
2. 确保配置文件格式正确
3. 重启机器人使配置生效

#### 4. 批量删除消息失败
**症状**: 显示"删除0条消息"
**解决**:
1. 检查消息链接格式是否正确
2. 确认机器人有删除消息权限
3. 注意14天消息限制

#### 5. 三次警告制不生效
**症状**: 警告计数错误或不封禁
**解决**:
1. 确保在论坛帖子内操作
2. 检查帖主权限
3. 查看机器人日志确认警告记录

---

## 📚 高级配置

### 自定义日志级别
修改config.json中的日志配置：
```json
"logging": {
    "enabled": true,
    "guild_id": 你的服务器ID,
    "channel_id": 日志频道ID,
    "level": "DEBUG"  // 可选: DEBUG, INFO, WARNING, ERROR
}
```

### 模块管理
可以通过修改config.json或使用机器人管理命令动态启用/禁用模块：
```json
"cogs": {
    "模块名": {"enabled": false}  // 禁用特定模块
}
```

### 赛事管理配置
赛事管理功能现在为默认启用，必需配置：
```json
"event_managers": [赛事管理员用户ID],
"highest_role_available": 最高可管理身份组ID,  // 设为0表示无限制
"cogs": {
    "event": {"enabled": true}
}
```

---

## 🛡️ 安全建议

1. **Token安全**
   - 绝不要将Token提交到公开代码仓库
   - 定期重新生成Token
   - 使用环境变量存储敏感信息

2. **权限控制**
   - 只给必要的管理员添加到admins列表（推荐使用用户ID）
   - 定期检查和更新管理员权限
   - 监控机器人日志中的管理操作

3. **服务器安全**
   - 定期备份配置文件
   - 监控异常活动
   - 及时更新机器人代码

4. **匿名反馈安全**
   - 监控恶意匿名反馈
   - 合理使用三次警告制
   - 定期检查匿名反馈统计

---

## 🔄 更新维护

### 定期备份
重要文件：
- `config.json` - 配置文件
- `data/` 目录 - 用户数据 (如果存在)
- `logs/` 目录 - 日志文件

### 更新流程
1. **备份现有配置和数据**
2. **下载新版本代码**
3. **对比配置文件变更** (查看 `config.example.json` 的改动)
4. **测试新功能**
5. **正式部署**

### 监控指标
- 机器人在线时间
- 命令执行成功率
- 错误日志频率
- 用户活跃度

---

## 💬 获取帮助

如果遇到问题：

1.  查看机器人日志文件
2.  使用配置验证脚本
3.  在github/discord上联系开发者

**祝您使用愉快！** 